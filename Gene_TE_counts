#!/bin/bash

# =========================================================
# Run TEcount in parallel for BAM files in current directory
# =========================================================

# Number of parallel TEcount processes to run at once
JOBS=10   # adjust depending on CPU and memory

# Paths to annotation files
gene_gtf="/mnt/data2/GTEX/TEcount_test/GTF_files/cleaned_gene_annotation.gtf"
TE_gtf="/mnt/data2/GTEX/TEcount_test/GTF_files/GRCh38_GENCODE_rmsk_TE.gtf"

# Strandness of the library
stranded="no"

# Path to TEcount binary
TEcount_path="/home/habtemar/tools/TEtranscripts/venv/bin/TEcount"

# Output directories
mkdir -p counts logs

echo "Starting TEcount for BAM files in $(pwd)"
echo "Running $JOBS parallel jobs"

# Run TEcount in parallel using xargs
ls *.bam | xargs -P "$JOBS" -I {} bash -c '
  bam_file="{}"
  bam_name=$(basename "$bam_file" .bam)
  echo "Processing $bam_name ..."

  '"$TEcount_path"' \
    --BAM "$bam_file" \
    --GTF "'"$gene_gtf"'" \
    --TE "'"$TE_gtf"'" \
    --project "counts/${bam_name}" \
    --mode multi \
    --sortByPos \
    --stranded "'"$stranded"'" \
    > "logs/${bam_name}.out" 2> "logs/${bam_name}.err"

  echo "Done: $bam_name"
'

echo "All TEcount jobs finished!"

